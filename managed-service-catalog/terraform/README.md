# Terraform Platform Provisioning â€“ STACKIT Cloud (Edge & Public)

> âš™ï¸ This setup is powered by [`kubara`](https://kubara.git.onstackit.cloud/STACKIT/kubara/wiki), which generates cluster-specific Terraform configurations from reusable module templates. You define your intent, `kubara` does the heavy lifting. If you are reading this README, you are likely using the `kubara` CLI to bootstrap your Kubernetes clusters or someone else has already done it for you.

---

## ğŸ“¦ What You Get

Provision fully-featured Kubernetes environments on STACKIT â€“ Edge or Public Cloud â€“ using opinionated, production-grade Terraform modules.

- âœ¨ Modular, reusable Terraform setup
- ğŸ”„ Dynamically generated config via `kubara`
- ğŸ§© One config file per cluster: `env.auto.tfvars`
- ğŸš« No manual module editing required
- âœ… Argo CD-ready, SSO-ready, DNS, Vault, IAM & more

---

## ğŸ§± Folder Structure

The whole folder structure is generated by `kubara` and looks like this:

```
customer-service-catalog/
â””â”€â”€ terraform/
    â””â”€â”€ <CLUSTERNAME>/
        â”œâ”€â”€ bootstrap-tfstate-backend/
        â””â”€â”€ infrastructure/
            â”œâ”€â”€ env.auto.tfvars     # ğŸ”§ Adjust this file, if you need
            â”œâ”€â”€ main.tf
            â”œâ”€â”€ variables.tf
            â”œâ”€â”€ terraform.tf
            â””â”€â”€ set-env.sh/.ps1
managed-service-catalog/
â””â”€â”€ terraform/
    â””â”€â”€ modules/                   # Reusable Terraform modules
```

> ğŸ’¡ Want to create a new cluster? Donâ€™t copy folders manually. Use:
>
> ```bash
> kubara --terraform
> ```

---

## ğŸ› ï¸ Prerequisites

Make sure you have:

1. Access to the [STACKIT Cloud Portal](https://portal.stackit.cloud)
2. A valid **Service Account** (incl. project permissions)
3. Terraform v1.9 or newer
4. The `kubara` CLI installed
5. (Optional) `jq` for handling JSON output

---

## ğŸ” Step 1 â€“ Authentication Setup

Start by duplicating the helper script:

```bash
cp set-env-changeme.sh set-env.sh
vim set-env.sh
```

Or on Windows:

```powershell
cp set-env-changeme.ps1 set-env.ps1
notepad set-env.ps1
```

Add your STACKIT credentials (SERVICE_ACCOUNT_KEY authentication is reccomended):

```bash
export STACKIT_SERVICE_ACCOUNT_KEY_PATH="/path/to/your-service-account.json"
export STACKIT_PRIVATE_KEY_PATH="/path/to/private-key.pem"
```

Youâ€™ll add `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` later (after the s3-bucket that stores terraform state is created).<br>
If you want to use an existing s3-bucket that you control,
you can set the vars accordingly and skip the Step "Create Remote State Backend".<br>
Consider the security implications regarding sensitive values in terraform state before using an existing s3-bucket.

Then run:

```bash
source set-env.sh      # or . .\set-env.ps1 on PowerShell
```

---

## ğŸš€ Step 2 â€“ Generate Cluster Templates (No need, just for new Cluster)

Create a new cluster setup using `kubara`:

```bash
kubara --terraform
```

Based on your `config.yaml` and if you are setting by `kubernetesType`, this generates a pre-wired Terraform folder for edge oder cloud (SKE):

- Includes `main.tf`, `variables.tf`, and `terraform.tf`
- Generates a ready-to-edit `env.auto.tfvars`

ğŸ“ All configuration goes into that one file.

---

## âš™ï¸ Step 3 â€“ Edit `env.auto.tfvars`

This file contains all inputs for your cluster. Hereâ€™s an example:

```hcl
### DNS
contact_email           = "hello@demo.io
dns_name                = "demo.stackit.run"

### Global
project_id              = "38867e..."
stage                   = "prod"
name                    = "demo"



### Secret Manager / Vault Users
 users = [
        {
            description   = "vault-user-rw"
            write_enabled = true
        },
        {
            description   = "vault-user-ro"
            write_enabled = false
        }
    ]

### Kubernetes

### SKE
kubernetes_version_min = "1.32.5"
node_pools = [
        {
            availability_zones = ["eu01-2"]
            machine_type       = "c1.5"
            maximum            = 4
            minimum            = 2
            name               = "pool-infra"
            os_version_min     = "4152.2.3"
            labels = {
                "project" = "public-cloud-demo"
                "role"    = "infra"
            }
            taints = []
        }
    ]


```

> ğŸ’¡ `env.auto.tfvars` is generated by `kubara`, but feel free to add more supported variables to match your infrastructure requirements.

---

## â˜ï¸ Step 4 â€“ Create Remote State Backend

Navigate to:

```bash
cd customer-service-catalog/terraform/<CLUSTERNAME>/bootstrap-tfstate-backend
```

Run:

```bash
terraform init
terraform apply
```

Export the remote state credentials:

```bash
export AWS_ACCESS_KEY_ID="..."
export AWS_SECRET_ACCESS_KEY="..."
```

Then re-source your environment:

```bash
source ../infrastructure/set-env.sh
```

---

## ğŸ—ï¸ Step 5 â€“ Apply Infrastructure

Go to the infrastructure directory:

```bash
cd ../infrastructure
```

Then:

```bash
terraform init
terraform plan
terraform apply
```

ğŸ‰ This provisions everything:

- Kubernetes (Edge or Public)
- DNS zone
- IAM roles
- Vault (Secrets Manager)
- Secrets in Vault
- Buckets
- Image uploads (optional)
- And more...

---

## ğŸŒ Visual Overview

### Edge Cloud Architecture

![STACKIT Edge](images/edge-0.png)

In the picture above you can see what happening behind the scenes and which resources are created. The difference to the following public cloud architecture is that the Edge Cloud uses MetalLB for load balancing and does not require a public IP address. Also you create a server over terraform which be used to deploy the kubernetes cluster through providing or referencing a talos image.

### Public Cloud (SKE) Architecture

![STACKIT Public Cloud](images/public-cloud-0.png)

In the picture above you can see what happening behind the scenes and which resources are created and how the kubernetes platform components are connected to the managed services.

---

## ğŸ”‘ Step 6 â€“ Export Kubeconfig

Extract and save the kubeconfig:

```bash
terraform output -json kubeconfig_raw | jq -r > ~/.kube/<CLUSTERNAME>.yaml
```

Then use it:

```bash
KUBECONFIG=~/.kube/<CLUSTERNAME>.yaml kubectl get nodes
```

---

## ğŸ”— Resources

- [STACKIT Terraform Provider](https://registry.terraform.io/providers/stackitcloud/stackit/latest)
- [kubara Wiki](https://kubara.git.onstackit.cloud/STACKIT/kubara/wiki)

---

## ğŸ’¬ Need Help?

Questions, problems, edge cases?
> ğŸ‘‰ Ask in Teams
> ğŸ‘‰ Open a Git issue

You're not doing Terraform alone â€“ neither are we.
